{%  load static %} 
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinFlow Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
        <link rel="stylesheet" href="{% static 'styles/dashboardStyle.css' %}">
    
    <style>
      /* Sensor Grid Styles */
      .sensor-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .sensor-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      
      .sensor-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
      
      .sensor-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }
      
      .sensor-card.temperature .sensor-icon {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      }
      
      .sensor-card.humidity .sensor-icon {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
      }
      
      .sensor-card.pressure .sensor-icon {
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
      }
      
      .sensor-card.gas .sensor-icon {
        background: linear-gradient(135deg, #00b894, #00a085);
      }
      
      .sensor-info {
        flex: 1;
      }
      
      .sensor-value {
        font-size: 28px;
        font-weight: bold;
        color: #2d3436;
        margin-bottom: 5px;
      }
      
      .sensor-label {
        font-size: 14px;
        color: #636e72;
        font-weight: 500;
      }
      
      /* Device Info Styles */
      .device-info {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      .info-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #636e72;
      }
      
      .info-item:last-child {
        margin-bottom: 0;
      }
      
      .info-item i {
        width: 20px;
        color: #4270F4;
      }
      
      /* Status Indicators */
      .status-online {
        color: #00b894;
        font-weight: 600;
      }
      
      .status-offline {
        color: #636e72;
        font-weight: 600;
      }
      
      .status-error {
        color: #e17055;
        font-weight: 600;
      }
      
      /* Temperature Chart */
      .temperature-chart {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img src="{% static 'images/smartForGreenLogo.jpg' %}" alt="Smart For Green Logo" width="50px" height="50px" class="logo-image">
        Smart For Green
        
      </div>

      <div class="nav-menu">
        <a href="#" class="nav-item active">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-user-circle"></i>
          <span>Account</span>
        </a>
        
        
      </div>

     
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <div class="welcome-section">
          <p class="greeting">Good afternoon, Aziz,</p>
          <h1 class="welcome-title">IoT Temperature Monitoring Dashboard</h1>
        </div>

        <div class="header-right">
          <div class="notification-bell">
            <i class="fas fa-bell"></i>
            <!-- <div class="notification-indicator"></div> -->
          </div>

          <div class="user-profile">
            <img
              src={% static 'images/smartForGreenLogo.jpg' %}
              alt="Alex Morgan"
              class="profile-pic"
            />
          </div>

          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Find transactions..." />
          </div>
        </div>
      </div>

      <!-- Dashboard Container -->
      <div class="dashboard-container">
        <!-- Main Dashboard Content -->
        <div class="dashboard-main">
          <!-- Transfer Cards -->
          

          <!-- TTN Temperature Widget -->
          <div class="temperature-section">
            <h3 class="section-title">IoT Sensor Monitor</h3>
            
            <!-- Main Sensor Grid -->
            <div class="sensor-grid">
              <!-- Temperature Sensor -->
              <div class="sensor-card temperature">
                <div class="sensor-icon">
                  <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="sensor-info">
                  <div class="sensor-value">
                    <span id="current-temp">--</span>°C
                  </div>
                  <div class="sensor-label">Temperature</div>
                </div>
              </div>
              
              <!-- Humidity Sensor -->
              <div class="sensor-card humidity">
                <div class="sensor-icon">
                  <i class="fas fa-tint"></i>
                </div>
                <div class="sensor-info">
                  <div class="sensor-value">
                    <span id="current-humidity">--</span>%
                  </div>
                  <div class="sensor-label">Humidity</div>
                </div>
              </div>
              
              <!-- Pressure Sensor -->
              <div class="sensor-card pressure">
                <div class="sensor-icon">
                  <i class="fas fa-compress-alt"></i>
                </div>
                <div class="sensor-info">
                  <div class="sensor-value">
                    <span id="current-pressure">--</span> hPa
                  </div>
                  <div class="sensor-label">Pressure</div>
                </div>
              </div>
              
              <!-- Gas Sensor -->
              <div class="sensor-card gas">
                <div class="sensor-icon">
                  <i class="fas fa-wind"></i>
                </div>
                <div class="sensor-info">
                  <div class="sensor-value">
                    <span id="current-gas">--</span>
                  </div>
                  <div class="sensor-label">Gas</div>
                </div>
              </div>
            </div>
            
            <!-- Device Info Section -->
            <div class="device-info">
              <div class="info-item">
                <i class="fas fa-microchip"></i>
                <span id="device-id">Device: --</span>
              </div>
              <div class="info-item">
                <i class="fas fa-clock"></i>
                <span id="last-update">Last Update: --</span>
              </div>
              <div class="info-item">
                <i class="fas fa-signal"></i>
                <span>Status: <span id="connection-status" class="status-offline">Offline</span></span>
              </div>
            </div>
            
            <!-- Temperature Chart -->
            <div class="temperature-chart">
              <canvas id="temperatureChart" width="300" height="100"></canvas>
            </div>
          </div>

          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript for Temperature Widget -->
    <script>
      // Temperature update functionality
      let temperatureChart;
      let temperatureHistory = [];
      
      // Initialize temperature chart
      function initTemperatureChart() {
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        temperatureChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'Temperature (°C)',
              data: [],
              borderColor: '#4270F4',
              backgroundColor: 'rgba(66, 112, 244, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
      
      // Update temperature data
      function updateTemperature() {
        const url = `/api/ttn/temperature/`;
        fetch(url, { cache: 'no-store' })
          .then(response => response.json())
          .then(data => {
            const hasTemp = data.temperature !== null && data.temperature !== undefined;
            const isFresh = data.is_fresh === undefined ? true : !!data.is_fresh;

            if (hasTemp) {
              // Update temperature display (show temperature regardless of freshness)
              document.getElementById('current-temp').textContent = data.temperature;
              
              // Update other sensor values
              if (data.humidity !== undefined) {
                document.getElementById('current-humidity').textContent = data.humidity;
              }
              if (data.pressure !== undefined) {
                document.getElementById('current-pressure').textContent = data.pressure;
              }
              if (data.gas !== undefined) {
                document.getElementById('current-gas').textContent = data.gas;
              }
              
              // Update device info
              if (data.device_id) {
                document.getElementById('device-id').textContent = `Device: ${data.device_id}`;
              }
              
              // Update last update time
              if (data.last_update) {
                const date = new Date(data.last_update);
                const formattedDate = date.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                }) + ', ' + date.toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                });
                document.getElementById('last-update').textContent = `Last Update: ${formattedDate}`;
              }
              
              // Update connection status based on freshness
              if (isFresh) {
                document.getElementById('connection-status').textContent = 'Online';
                document.getElementById('connection-status').className = 'status-online';
              } else {
                document.getElementById('connection-status').textContent = 'Offline';
                document.getElementById('connection-status').className = 'status-offline';
              }
              
              // Add to chart history
              const now = new Date();
              const timeLabel = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              
              temperatureHistory.push({
                time: timeLabel,
                temp: data.temperature
              });
              
              // Keep only last 10 readings
              if (temperatureHistory.length > 10) {
                temperatureHistory.shift();
              }
              
              // Update chart
              if (temperatureChart) {
                temperatureChart.data.labels = temperatureHistory.map(item => item.time);
                temperatureChart.data.datasets[0].data = temperatureHistory.map(item => item.temp);
                temperatureChart.update();
              }
            } else {
              // No temperature data available
              document.getElementById('current-temp').textContent = '--';
              
              // Check if we have an error message
              if (data.error) {
                document.getElementById('connection-status').textContent = 'Error';
                document.getElementById('connection-status').className = 'status-error';
                
                // Show error details in console
                console.warn('TTN API Error:', data.error, data.message);
              } else if (data.message) {
                document.getElementById('connection-status').textContent = 'No Data';
                document.getElementById('connection-status').className = 'status-offline';
                
                // Show message details in console
                console.info('TTN API Message:', data.message);
              } else {
                document.getElementById('connection-status').textContent = 'Offline';
                document.getElementById('connection-status').className = 'status-offline';
              }
              
              // Update device info if available
              if (data.device_id) {
                document.getElementById('device-id').textContent = `Device: ${data.device_id}`;
              }
              
              // Update last update time if available
              if (data.last_update) {
                const date = new Date(data.last_update);
                const formattedDate = date.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                }) + ', ' + date.toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                });
                document.getElementById('last-update').textContent = `Last Update: ${formattedDate}`;
              }
            }
          })
          .catch(error => {
            console.error('Error fetching temperature data:', error);
            document.getElementById('connection-status').textContent = 'Error';
            document.getElementById('connection-status').className = 'status-error';
            document.getElementById('current-temp').textContent = '--';
          });
      }
      
      // Initialize chart when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize temperature chart
        if (typeof Chart !== 'undefined') {
          initTemperatureChart();
        }
        
        // Update temperature immediately
        updateTemperature();
        
        // Update temperature every 30 seconds
        setInterval(updateTemperature, 6000);
      });
    </script>
    
    <!-- Chart.js CDN for temperature chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </body>
</html>